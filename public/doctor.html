<!DOCTYPE html>
<html>
<head>
  <title>Zencuro - Doctor Panel</title>
  <style>
    body { font-family: Arial; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .videos { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
    video { width: 280px; border: 2px solid #333; border-radius:8px; }
    #chat { width: 300px; height: 150px; border: 1px solid #ccc; overflow-y: auto; padding:6px; }
    textarea { width:300px; min-height:100px; }
    .btn { padding:10px 14px; border:0; border-radius:8px; background:#067d62; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2>Doctor Consultation Panel</h2>
  <div class="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div>
    <h3>Chat</h3>
    <div id="chat"></div>
    <input type="text" id="msg" placeholder="Type a message..." />
    <button class="btn" onclick="sendMessage()">Send</button>
  </div>

  <div>
    <h3>Write Prescription</h3>
    <textarea id="prescriptionText" placeholder="Rx: ..."></textarea><br>
    <button class="btn" onclick="savePrescription()">Save Prescription</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const patientId = "patient1"; // TODO: dynamic selection
    const socket = io();
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const chatBox = document.getElementById("chat");
    let localStream, peerConnection;
    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    async function startCall() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
      peerConnection.ontrack = (e) => remoteVideo.srcObject = e.streams[0];
      peerConnection.onicecandidate = (e) => { if (e.candidate) socket.emit("candidate", e.candidate); };
    }
    startCall();

    socket.on("offer", async (offer) => {
      if (!peerConnection) {
        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
        peerConnection.ontrack = (e) => remoteVideo.srcObject = e.streams[0];
        peerConnection.onicecandidate = (e) => { if (e.candidate) socket.emit("candidate", e.candidate); };
      }
      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.emit("answer", answer);
    });
    socket.on("candidate", async (c) => { try { await peerConnection.addIceCandidate(new RTCIceCandidate(c)); } catch {} });
    socket.on("answer", async (ans) => { try { await peerConnection.setRemoteDescription(new RTCSessionDescription(ans)); } catch {} });

    function sendMessage() {
      const msg = document.getElementById("msg").value.trim();
      if (!msg) return;
      socket.emit("chatMessage", msg);
      document.getElementById("msg").value = "";
    }
    socket.on("chatMessage", (msg) => {
      const p = document.createElement("p");
      p.textContent = msg;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    async function savePrescription() {
      const text = document.getElementById("prescriptionText").value.trim();
      if (!text) return alert("Write something first");
      await fetch(`/prescription/${patientId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prescription: text })
      });
      alert("Prescription saved!");
    }
  </script>
</body>
</html>

